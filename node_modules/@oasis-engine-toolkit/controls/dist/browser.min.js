!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("oasis-engine")):"function"==typeof define&&define.amd?define(["exports","oasis-engine"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@oasisEngineToolkit/controls"]={},e.oasisEngine)}(this,(function(e,t){"use strict";function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,a(e,t)}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}function r(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var s=t.MathUtil.zeroTolerance,h=function(){function e(e,t,n){this.radius=e,this.phi=t,this.theta=n,this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==n?n:0}var n=e.prototype;return n.set=function(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this},n.makeSafe=function(){return this.phi=t.MathUtil.clamp(this.phi,s,Math.PI-s),this},n.setFromVec3=function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(t.MathUtil.clamp(e.y/this.radius,-1,1))),this},n.setToVec3=function(e){var t=this.radius,n=this.phi,i=this.theta,o=Math.sin(n)*t;return e.set(o*Math.sin(i),t*Math.cos(n),o*Math.cos(i)),this},e}(),l=t.MathUtil.zeroTolerance;function p(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return n.some((function(t){return-1!==e.indexOf(t)}))}var c,d,u=function(e){function n(n){var i;return(i=e.call(this,n)||this)._forward=new t.Vector3,i._right=new t.Vector3,i.camera=void 0,i.mainElement=void 0,i.domElement=void 0,i.movementSpeed=void 0,i.rotateSpeed=void 0,i.floorMock=void 0,i.floorY=void 0,i.press=void 0,i.keysForward=void 0,i.keysBackward=void 0,i.keysLeft=void 0,i.keysRight=void 0,i._theta=void 0,i._phi=void 0,i._moveForward=void 0,i._moveBackward=void 0,i._moveLeft=void 0,i._moveRight=void 0,i._v3Cache=void 0,i._spherical=void 0,i._rotateOri=void 0,i._events=void 0,i.camera=n,i.mainElement=i.engine.canvas._webCanvas,i.domElement=document,i.movementSpeed=1,i.rotateSpeed=1,i.floorMock=!0,i.floorY=0,i.press=!1,i.keysForward=["KeyW","ArrowUp"],i.keysBackward=["KeyS","ArrowDown"],i.keysLeft=["KeyA","ArrowLeft"],i.keysRight=["KeyD","ArrowRight"],i._theta=0,i._phi=0,i._moveForward=!1,i._moveBackward=!1,i._moveLeft=!1,i._moveRight=!1,i._v3Cache=new t.Vector3,i._spherical=new h,i._rotateOri=[0,0],i._events=[{type:"mousemove",listener:i.onMouseMove.bind(r(i))},{type:"touchmove",listener:i.onMouseMove.bind(r(i))},{type:"mousedown",listener:i.onMouseDown.bind(r(i))},{type:"touchstart",listener:i.onMouseDown.bind(r(i))},{type:"mouseup",listener:i.onMouseUp.bind(r(i))},{type:"touchend",listener:i.onMouseUp.bind(r(i))},{type:"keydown",listener:i.onKeyDown.bind(r(i)),element:window},{type:"keyup",listener:i.onKeyUp.bind(r(i)),element:window},{type:"contextmenu",listener:i.onContextMenu.bind(r(i))}],i.initEvents(),i.updateSpherical(),i}o(n,e);var i=n.prototype;return i.onContextMenu=function(e){e.preventDefault()},i.onKeyDown=function(e){var t=e.code,n=e.key,i=e.keyCode;p(this.keysForward,t,n,i)?this._moveForward=!0:p(this.keysBackward,t,n,i)?this._moveBackward=!0:p(this.keysLeft,t,n,i)?this._moveLeft=!0:p(this.keysRight,t,n,i)&&(this._moveRight=!0)},i.onKeyUp=function(e){var t=e.code,n=e.key,i=e.keyCode;p(this.keysForward,t,n,i)?this._moveForward=!1:p(this.keysBackward,t,n,i)?this._moveBackward=!1:p(this.keysLeft,t,n,i)?this._moveLeft=!1:p(this.keysRight,t,n,i)&&(this._moveRight=!1)},i.onMouseDown=function(e){e.stopPropagation(),e=e.changedTouches&&e.changedTouches[0]||e,this.domElement!==document&&this.domElement.focus(),this.press=!0,this._rotateOri=[e.clientX,e.clientY]},i.onMouseUp=function(e){e.preventDefault(),e.stopPropagation(),this.press=!1},i.onMouseMove=function(e){if(!1!==this.press&&!1!==this.enabled){e.preventDefault(),e.stopPropagation();var t=(e=e.changedTouches&&e.changedTouches[0]||e).clientX-this._rotateOri[0],n=e.clientY-this._rotateOri[1];this._rotateOri[0]=e.clientX,this._rotateOri[1]=e.clientY;var i=t*(180/this.mainElement.width),o=n*(180/this.mainElement.height);this.rotate(-i,o)}},i.rotate=function(e,n){void 0===e&&(e=0),void 0===n&&(n=0),this._theta+=t.MathUtil.degreeToRadian(e),this._phi+=t.MathUtil.degreeToRadian(n),this._phi=t.MathUtil.clamp(this._phi,l,Math.PI-l),this._spherical.theta=this._theta,this._spherical.phi=this._phi,this._spherical.setToVec3(this._v3Cache),t.Vector3.add(this.camera.transform.position,this._v3Cache,this._v3Cache),this.camera.transform.lookAt(this._v3Cache,new t.Vector3(0,1,0))},i.onUpdate=function(e){if(!1!==this.enabled){var t=e/1e3*this.movementSpeed;if(this.camera.transform.getWorldForward(this._forward),this.camera.transform.getWorldRight(this._right),this._moveForward&&this.camera.transform.translate(this._forward.scale(t),!1),this._moveBackward&&this.camera.transform.translate(this._forward.scale(-t),!1),this._moveLeft&&this.camera.transform.translate(this._right.scale(-t),!1),this._moveRight&&this.camera.transform.translate(this._right.scale(t),!1),this.floorMock){var n=this.camera.transform.position;n.y!==this.floorY&&this.camera.transform.setPosition(n.x,this.floorY,n.z)}}},i.initEvents=function(){var e=this;this._events.forEach((function(t){t.element?t.element.addEventListener(t.type,t.listener,!1):e.mainElement.addEventListener(t.type,t.listener,!1)}))},i.onDestroy=function(){var e=this;this._events.forEach((function(t){t.element?t.element.removeEventListener(t.type,t.listener,!1):e.mainElement.removeEventListener(t.type,t.listener,!1)}))},i.updateSpherical=function(){this._v3Cache.set(0,0,-1),t.Vector3.transformByQuat(this._v3Cache,this.camera.transform.rotationQuaternion,this._v3Cache),this._spherical.setFromVec3(this._v3Cache),this._theta=this._spherical.theta,this._phi=this._spherical.phi},n}(t.Script);function m(){return function(e){}}e.ControlHandlerType=void 0,(c=e.ControlHandlerType||(e.ControlHandlerType={}))[c.None=0]="None",c[c.ROTATE=1]="ROTATE",c[c.ZOOM=2]="ZOOM",c[c.PAN=4]="PAN",c[c.All=7]="All";var f,y,_,v=function(e){}(d=function(){function n(){}return n.onUpdateHandler=function(n){return n.isKeyHeldDown(t.Keys.ArrowLeft)||n.isKeyHeldDown(t.Keys.ArrowRight)||n.isKeyHeldDown(t.Keys.ArrowUp)||n.isKeyHeldDown(t.Keys.ArrowDown)?e.ControlHandlerType.PAN:e.ControlHandlerType.None},n.onUpdateDelta=function(e,n){var i=e.keyPanSpeed,o=e.input;n.x=n.y=0,o.isKeyHeldDown(t.Keys.ArrowLeft)&&(n.x+=i),o.isKeyHeldDown(t.Keys.ArrowRight)&&(n.x-=i),o.isKeyHeldDown(t.Keys.ArrowUp)&&(n.y+=i),o.isKeyHeldDown(t.Keys.ArrowDown)&&(n.y-=i)},n}())||d;!function(e){e[e.Moving=0]="Moving",e[e.Distance=1]="Distance"}(_||(_={}));var T,g=function(e){}((y=function(){function n(){}return n.onUpdateHandler=function(n){switch(++this._frameIndex,n.pointers.length){case 1:n.isPointerHeldDown(t.PointerButton.Secondary)?this._updateType(e.ControlHandlerType.PAN,_.Moving):n.isPointerHeldDown(t.PointerButton.Auxiliary)?this._updateType(e.ControlHandlerType.ZOOM,_.Moving):n.isPointerHeldDown(t.PointerButton.Primary)?this._updateType(e.ControlHandlerType.ROTATE,_.Moving):0!==n.pointerMovingDelta.x&&0!==n.pointerMovingDelta.y?n.isPointerUp(t.PointerButton.Secondary)?this._updateType(e.ControlHandlerType.PAN,_.Moving):n.isPointerUp(t.PointerButton.Auxiliary)?this._updateType(e.ControlHandlerType.ZOOM,_.Moving):n.isPointerUp(t.PointerButton.Primary)?this._updateType(e.ControlHandlerType.ROTATE,_.Moving):this._updateType(e.ControlHandlerType.None,_.Moving):this._updateType(e.ControlHandlerType.None,_.Moving);break;case 2:this._updateType(e.ControlHandlerType.ZOOM,_.Distance);break;case 3:this._updateType(e.ControlHandlerType.PAN,_.Moving);break;default:this._updateType(e.ControlHandlerType.None,_.Moving)}return this._handlerType},n.onUpdateDelta=function(e,n){var i=this._frameIndex;switch(this._deltaType){case _.Moving:if(this._lastUsefulFrameIndex===i-1){var o=e.input.pointerMovingDelta;n.x=o.x,n.y=o.y}else n.x=0,n.y=0;break;case _.Distance:var a=e.input.pointers,r=a[0],s=a[1],h=t.Vector2.distance(r.position,s.position);this._lastUsefulFrameIndex===i-1?n.set(0,this._distanceOfPointers-h,0):n.set(0,0,0),this._distanceOfPointers=h}this._lastUsefulFrameIndex=i},n._updateType=function(e,t){this._handlerType===e&&this._deltaType===t||(this._handlerType=e,this._deltaType=t,this._lastUsefulFrameIndex=-1)},n}(),y._deltaType=_.Moving,y._handlerType=e.ControlHandlerType.None,y._frameIndex=0,y._lastUsefulFrameIndex=-1,y._distanceOfPointers=0,f=y))||f,w=function(e){}(T=function(){function t(){}return t.onUpdateHandler=function(t){var n=t.wheelDelta;return 0===n.x&&0===n.y&&0===n.z?e.ControlHandlerType.None:e.ControlHandlerType.ZOOM},t.onUpdateDelta=function(e,t){t.copyFrom(e.input.wheelDelta)},t}())||T,H=function(n){function a(){for(var i,o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return(i=n.call.apply(n,[this].concat(a))||this).canvas=void 0,i.input=void 0,i.inputDevices=[v,g,w],i.camera=void 0,i.cameraTransform=void 0,i.target=new t.Vector3,i.up=new t.Vector3(0,1,0),i.autoRotate=!1,i.autoRotateSpeed=Math.PI,i.enableDamping=!0,i.rotateSpeed=1,i.zoomSpeed=1,i.keyPanSpeed=7,i.dampingFactor=.1,i.zoomFactor=.2,i.minDistance=.1,i.maxDistance=1/0,i.minZoom=0,i.maxZoom=1/0,i.minPolarAngle=0,i.maxPolarAngle=Math.PI,i.minAzimuthAngle=-1/0,i.maxAzimuthAngle=1/0,i._enableKeys=!0,i._spherical=new h,i._sphericalDelta=new h,i._sphericalDump=new h,i._zoomFrag=0,i._scale=1,i._panOffset=new t.Vector3,i._tempVec3=new t.Vector3,i._enableHandler=e.ControlHandlerType.All,i}o(a,n);var r=a.prototype;return r.onAwake=function(){var e=this.engine,n=this.entity;this.canvas=e.canvas,this.input=e.inputManager,this.camera=n.getComponent(t.Camera),this.cameraTransform=n.transform},r.onUpdate=function(e){this._updateInputDelta(e),this._updateTransform()},r._updateInputDelta=function(t){for(var n=e.ControlHandlerType.None,i=this._tempVec3,o=this._enableHandler,a=this.inputDevices,r=this.input,s=a.length-1;s>=0;s--){var h=a[s],l=h.onUpdateHandler(r);if(l&o)switch(n|=l,h.onUpdateDelta(this,i),l){case e.ControlHandlerType.ROTATE:this._rotate(i);break;case e.ControlHandlerType.ZOOM:this._zoom(i);break;case e.ControlHandlerType.PAN:this._pan(i)}}var p=this._sphericalDump,c=this._sphericalDelta;if(this.enableDamping&&(o&e.ControlHandlerType.ZOOM&&n^e.ControlHandlerType.ZOOM&&(this._zoomFrag*=1-this.zoomFactor),o&e.ControlHandlerType.ROTATE&&n^e.ControlHandlerType.ROTATE&&(c.theta=p.theta*=1-this.dampingFactor,c.phi=p.phi*=1-this.dampingFactor)),n===e.ControlHandlerType.None&&this.autoRotate){var d=this.autoRotateSpeed/1e3*t;c.theta-=d}},r._rotate=function(e){var t=2*Math.PI*e.x/this.canvas.width*this.rotateSpeed;this._sphericalDelta.theta-=t;var n=2*Math.PI*e.y/this.canvas.height*this.rotateSpeed;this._sphericalDelta.phi-=n,this.enableDamping&&(this._sphericalDump.theta=-t,this._sphericalDump.phi=-n)},r._zoom=function(e){e.y>0?this._scale/=Math.pow(.95,this.zoomSpeed):e.y<0&&(this._scale*=Math.pow(.95,this.zoomSpeed))},r._pan=function(e){var n=this.cameraTransform,i=n.worldMatrix.elements,o=this.canvas.height,a=t.Vector3.distance(n.position,this.target)*(this.camera.fieldOfView/2)*(Math.PI/180),r=-2*e.x*(a/o),s=2*e.y*(a/o);this._panOffset.x+=i[0]*r+i[4]*s,this._panOffset.y+=i[1]*r+i[5]*s,this._panOffset.z+=i[2]*r+i[6]*s},r._updateTransform=function(){var e=this.cameraTransform,n=this.target,i=this._tempVec3,o=this._spherical,a=this._sphericalDelta,r=this._panOffset;t.Vector3.subtract(e.position,n,i),o.setFromVec3(i),o.theta+=a.theta,o.phi+=a.phi,o.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,o.theta)),o.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,o.phi)),o.makeSafe(),1!==this._scale&&(this._zoomFrag=o.radius*(this._scale-1)),o.radius+=this._zoomFrag,o.radius=Math.max(this.minDistance,Math.min(this.maxDistance,o.radius)),o.setToVec3(i),t.Vector3.add(n.add(r),i,e.position),e.lookAt(n,this.up),this._zoomFrag=0,this._scale=1,a.set(0,0,0),r.set(0,0,0)},i(a,[{key:"enableKeys",get:function(){return this._enableKeys},set:function(e){if(this._enableKeys!==e){this._enableKeys=e;var t=this.inputDevices;if(e)t.push(v);else for(var n=t.length-1;n>=0;n--)if(t[n]===v){t.splice(n,1);break}}}},{key:"enableRotate",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.ROTATE)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.ROTATE:this._enableHandler&=~e.ControlHandlerType.ROTATE}},{key:"enableZoom",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.ZOOM)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.ZOOM:this._enableHandler&=~e.ControlHandlerType.ZOOM}},{key:"enablePan",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.PAN)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.PAN:this._enableHandler&=~e.ControlHandlerType.PAN}}]),a}(t.Script),M=function(n){function a(i){var o;return(o=n.call(this,i)||this).canvas=void 0,o.input=void 0,o.inputDevices=[v,g,w],o.camera=void 0,o.cameraTransform=void 0,o.target=new t.Vector3,o.up=new t.Vector3(0,1,0),o.autoRotate=!1,o.autoRotateSpeed=Math.PI,o.enableKeys=!1,o.enableDamping=!0,o.rotateSpeed=1,o.zoomSpeed=1,o.keyPanSpeed=7,o.dampingFactor=.1,o.zoomFactor=.2,o.minDistance=.1,o.maxDistance=1/0,o.minZoom=0,o.maxZoom=1/0,o.minPolarAngle=0,o.maxPolarAngle=Math.PI,o.minAzimuthAngle=-1/0,o.maxAzimuthAngle=1/0,o._zoomScaleUnit=25,o._scale=1,o._panOffset=new t.Vector3,o._tempVec3=new t.Vector3,o._enableHandler=e.ControlHandlerType.All,o.enableRotate=!1,o}o(a,n);var r=a.prototype;return r.onAwake=function(){var e=this.engine,n=this.entity;this.canvas=e.canvas,this.input=e.inputManager,this.camera=n.getComponent(t.Camera),this.cameraTransform=n.transform},r.onUpdate=function(e){this._updateInputDelta(e),this._updateCamera()},r._updateInputDelta=function(t){e.ControlHandlerType.None;for(var n=this._tempVec3,i=this._enableHandler,o=this.inputDevices,a=this.input,r=o.length-1;r>=0;r--){var s=o[r],h=s.onUpdateHandler(a);if(h&i)switch(s.onUpdateDelta(this,n),h){case e.ControlHandlerType.ZOOM:this._zoom(n);break;case e.ControlHandlerType.PAN:this._pan(n)}}},r._zoom=function(e){e.y>0?this._scale/=Math.pow(.95,this.zoomSpeed):e.y<0&&(this._scale*=Math.pow(.95,this.zoomSpeed))},r._pan=function(e){this._panOffset.copyFrom(e)},r._updateCamera=function(){var e=this.cameraTransform,t=this.camera,n=this._panOffset,i=this._zoomScaleUnit*(this._scale-1),o=t.orthographicSize+i;t.orthographicSize=Math.max(this.minZoom,Math.min(this.maxZoom,o));var a=this.canvas,r=a.width,s=a.height,h=n.x,l=n.y,p=2*t.orthographicSize,c=p*t.aspectRatio,d=p,u=e.position,m=this._tempVec3;m.x=u.x-h*c/r,m.y=u.y+l*d/s,m.z=u.z,e.position=m,this._scale=1,n.set(0,0,0)},i(a,[{key:"enableRotate",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.ROTATE)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.ROTATE:this._enableHandler&=~e.ControlHandlerType.ROTATE}},{key:"enableZoom",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.ZOOM)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.ZOOM:this._enableHandler&=~e.ControlHandlerType.ZOOM}},{key:"enablePan",get:function(){return 0!=(this._enableHandler&e.ControlHandlerType.PAN)},set:function(t){t?this._enableHandler|=e.ControlHandlerType.PAN:this._enableHandler&=~e.ControlHandlerType.PAN}}]),a}(t.Script);e.ControlKeyboard=v,e.ControlPointer=g,e.ControlWheel=w,e.FreeControl=u,e.OrbitControl=H,e.OrthoControl=M,e.StaticInterfaceImplement=m,Object.defineProperty(e,"__esModule",{value:!0})}));
